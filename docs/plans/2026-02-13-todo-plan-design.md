# Plan Todos - 设计文档

> 创建日期：2026-02-13

## 一、产品概述

**产品定位**：本地优先的跨平台任务管理应用，融合短期 TODO 与长期 PLAN，帮助用户追踪日常事务与长期目标。

**核心理念**：
- 本地化存储，数据不上云（隐私优先）
- 短期任务与长期计划无缝关联
- 跨平台支持（桌面 + 移动 + Web 调试）

---

## 二、技术架构

### 2.1 技术栈

| 组件 | 技术选择 |
|------|----------|
| 核心框架 | Tauri v2 (Rust) |
| 前端 | Next.js (App Router) + React |
| 语言 | TypeScript |
| 数据库 | SQLite (本地文件) |
| 测试 | Vitest + Playwright |
| UI 设计系统 | ui-ux-pro-max (Fira Code/Sans + Teal/Orange) |

### 2.2 架构图

```
                    ┌─────────────────────────────────┐
                    │        Rust 核心业务逻辑          │
                    │   (数据库操作、通知、计划任务)    │
                    └─────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌───────────┐   ┌───────────┐   ┌───────────┐
            │  Tauri    │   │  Tauri    │   │  Tauri    │
            │  Desktop  │   │   iOS     │   │ Android   │
            │ (Windows) │   │ (WebView) │   │ (WebView) │
            └───────────┘   └───────────┘   └───────────┘

     ┌──────────────────────────────────────────────────────┐
     │              Web 调试模式 (开发时)                    │
     │   Tauri dev server → 浏览器访问 ←→ Rust 后端共享    │
     └──────────────────────────────────────────────────────┘
```

### 2.3 数据模型

```typescript
// Plan - 长期计划
interface Plan {
  id: string;
  title: string;
  description?: string;
  targetDate?: Date;        // 目标日期
  status: 'active' | 'completed' | 'archived';
  createdAt: Date;
  updatedAt: Date;
}

// Milestone - 里程碑
interface Milestone {
  id: string;
  planId: string;
  title: string;
  targetDate?: Date;
  status: 'pending' | 'completed';
}

// Todo - 短期任务
interface Todo {
  id: string;
  title: string;
  content?: string;
  dueDate?: Date;           // 截止日期
  status: 'pending' | 'in-progress' | 'done';
  planIds: string[];        // 关联的 Plan（多对多）
  milestoneId?: string;     // 可选关联到里程碑
  createdAt: Date;
  updatedAt: Date;
}

// NotificationConfig - 通知配置
interface NotificationConfig {
  id: string;
  type: 'feishu' | 'dingtalk' | 'email' | 'webhook';
  enabled: boolean;
  config: Record<string, string>;  // 平台特定配置
}
```

---

## 三、核心功能

### 3.1 TODO 管理

- 创建/编辑/删除 TODO
- 设置截止日期
- 标记状态（待处理/进行中/已完成）
- 关联到多个 PLAN（自由关联）
- 关联到里程碑（蓝图模式）

### 3.2 PLAN 管理

- 创建/编辑/删除长期计划
- 设置目标日期
- 设定里程碑
- 追踪完成进度（关联 TODO 的完成百分比）
- 归档已完成计划

### 3.3 视图模式

| 视图 | 描述 |
|------|------|
| **列表视图** | 层级展示 PLAN → Milestone → TODO |
| **日历视图** | 月/周/日视图，按日期显示 TODO |
| **时间轴视图** | 甘特图样式，横向展示时间分布 |

### 3.4 推送通知

#### 插件式架构

```
┌─────────────────────────────────────────────┐
│              Notification Core              │
│  ┌─────────────────────────────────────────┐ │
│  │ Event Bus - 事件中心                     │ │
│  └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────┐
│              Plugin Interface               │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────────┐  │
│  │飞书  │ │钉钉  │ │ 邮件  │ │ Webhook  │  │
│  │插件  │ │插件  │ │ 插件  │ │   插件   │  │
│  └──────┘ └──────┘ └──────┘ └──────────┘  │
└─────────────────────────────────────────────┘
```

#### 通知类型

| 类型 | 触发条件 | 示例 |
|------|----------|------|
| 定时提醒 | 到期前 X 分钟/小时/天 | "项目A设计稿还有 30 分钟到期" |
| 事件触发 | 任务完成/新建/更新 | "你已完成 '回复邮件'" |
| 每日汇总 | 每天早上 9 点 | "今日 3 件待办，2 件已过期" |

#### 定时任务

- 应用内检查：每次打开应用/每 5 分钟检查
- 系统备份：注册系统定时任务（Windows 计划任务 / macOS launchd）

---

## 四、UI/UX 设计

### 4.1 设计系统

使用 ui-ux-pro-max 生成的设计系统：

| 元素 | 规格 |
|------|------|
| 主色 | `#0D9488` (Teal) |
| 次色 | `#14B8A6` |
| 强调/CTA | `#F97316` (Orange) |
| 背景 | `#F0FDFA` |
| 文字 | `#134E4A` |
| 标题字体 | Fira Code |
| 正文字体 | Fira Sans |

### 4.2 风格

- **微交互**：小动画、手感反馈、流畅过渡
- 适合移动端和生产力工具

### 4.3 响应式布局

```
┌─────────────────────────────────────────────────┐
│ 桌面端 (>1024px)                                │
│ ┌──────────┬────────────────────────────────┐  │
│ │  侧边栏   │           主内容区              │  │
│ │  (240px) │                                │  │
│ └──────────┴────────────────────────────────┘  │
├─────────────────────────────────────────────────┤
│ 平板端 (768-1024px)                             │
│ ┌────────────┬─────────────────────────────┐   │
│ │  侧边栏    │        主内容区               │   │
│ │  (可收起)  │                              │   │
│ └────────────┴─────────────────────────────┘   │
├─────────────────────────────────────────────────┤
│ 手机端 (<768px)                                 │
│ ┌─────────────────────────┐                    │
│ │  底部导航栏              │                    │
│ │  [首页] [日历] [时间轴] [设置]                │                    │
│ └─────────────────────────┘                    │
└─────────────────────────────────────────────────┘
```

---

## 五、数据流与状态管理

### 5.1 前端状态

```
React Context
├── TodoContext - TODO 列表状态
├── PlanContext - PLAN 列表状态  
└── UIContext - 视图切换、侧边栏状态
```

### 5.2 Tauri IPC

| 操作 | 命令 | 说明 |
|------|------|------|
| 获取所有 TODO | `get_todos` | 返回列表 |
| 创建 TODO | `create_todo` | 传入 title, content, dueDate, planIds |
| 更新 TODO | `update_todo` | 支持部分更新 |
| 删除 TODO | `delete_todo` | 软删除 |
| 获取所有 PLAN | `get_plans` | 返回列表 |
| 创建 PLAN | `create_plan` | 传入 title, description, targetDate |
| 发送通知 | `send_notification` | 调用通知插件 |

---

## 六、错误处理

### 6.1 前端

- **乐观更新**：UI 先更新，后台同步
- **错误回滚**：同步失败时恢复原状态
- **Toast 通知**：操作结果即时反馈

### 6.2 后端 (Rust)

- **Result 类型**：`Result<T, AppError>`
- **错误日志**：写入本地日志文件
- **数据校验**：创建/更新前校验必填字段

---

## 七、测试策略

| 层级 | 工具 | 覆盖范围 |
|------|------|----------|
| 单元测试 | Vitest | 业务逻辑、工具函数 |
| 集成测试 | Vitest | Tauri 命令、数据库 CRUD |
| E2E 测试 | Playwright | 核心用户流程 |

### 核心测试场景

1. 创建 TODO → 关联 PLAN → 完成 → 验证进度
2. 日历视图创建/移动 TODO
3. 通知插件发送测试

---

## 八、里程碑规划

### Phase 1: 核心框架

- [ ] Tauri 项目初始化
- [ ] SQLite 数据库集成
- [ ] 基础 CRUD API

### Phase 2: 前端开发

- [ ] 列表视图
- [ ] 日历视图
- [ ] 时间轴视图
- [ ] 响应式布局

### Phase 3: 通知系统

- [ ] 通知核心架构
- [ ] 飞书/钉钉/邮件/Webhook 插件
- [ ] 定时任务

### Phase 4: 移动端

- [ ] Tauri iOS 构建
- [ ] Tauri Android 构建

---

## 九、数据备份与同步

### 9.1 设计理念

本地存储优先，但支持通过第三方备份服务实现数据备份与多设备同步。

### 9.2 支持的备份服务

| 服务 | 类型 | 说明 |
|------|------|------|
| **iCloud** | 云同步 | Apple 用户，跨 iPhone/iPad/Mac |
| **Google Drive** | 云同步 | Android/跨平台用户 |
| **OneDrive** | 云同步 | Microsoft 生态用户 |
| **Dropbox** | 云同步 | 通用云盘 |
| **本地文件** | 手动备份 | 导出为 JSON/SQLite 文件 |
| **WebDAV** | 自托管 | 支持自建 NAS（如坚果云、Nextcloud） |

### 9.3 同步机制

```
┌─────────────────────────────────────────────────────┐
│                   数据同步层                          │
│  ┌─────────────────────────────────────────────────┐│
│  │           Sync Engine (Rust)                    ││
│  │  - 检测文件变化                                 ││
│  │  - 冲突解决（本地优先 / 服务端优先 / 手动合并） ││
│  │  - 增量同步                                     ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────┐
│                   存储层                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │ iCloud  │ │  Drive  │ │OneDrive │ │ WebDAV │ │
│  │  Drive  │ │         │ │         │ │        │ │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────────────────────┘
```

### 9.4 数据格式

- **SQLite 文件**：直接同步 `.db` 文件（简单，但可能有并发问题）
- **JSON 导出**：结构化数据，易于版本控制和冲突解决（推荐）

### 9.5 冲突解决策略

| 策略 | 描述 | 适用场景 |
|------|------|----------|
| **本地优先** | 保留本地修改，覆盖服务端 | 个人设备，不希望被其他设备干扰 |
| **服务端优先** | 保留服务端修改，覆盖本地 | 多设备协作，希望最新修改生效 |
| **手动合并** | 提示用户选择 | 重要数据，需要人工确认 |

### 9.6 备份设置界面

```
┌─────────────────────────────────────┐
│  设置 → 备份与同步                    │
├─────────────────────────────────────┤
│                                     │
│  ☑ 启用自动同步                      │
│  同步频率：每 [5] 分钟              │
│                                     │
│  选择同步服务：                      │
│  ○ iCloud                          │
│  ○ Google Drive                    │
│  ○ OneDrive                        │
│  ○ Dropbox                         │
│  ○ WebDAV   [配置]                 │
│  ○ 手动导出                        │
│                                     │
│  冲突解决策略：                     │
│  (○) 本地优先  ○ 服务端优先  ○ 手动 │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│  上次同步：2026-02-13 10:30        │
│  [立即同步]  [导出全部数据]          │
│                                     │
└─────────────────────────────────────┘
```

---

## 十、文件结构

```
plan-todos/
├── src/                      # Next.js 前端
│   ├── app/
│   ├── components/
│   ├── lib/
│   └── styles/
├── src-tauri/                # Rust 后端
│   ├── src/
│   │   ├── commands/         # Tauri 命令
│   │   ├── db/              # 数据库操作
│   │   ├── notifications/   # 通知系统
│   │   └── lib.rs
│   ├── Cargo.toml
│   └── tauri.conf.json
├── docs/
│   └── plans/               # 设计文档
├── design-system/           # 设计系统
├── AGENTS.md                # 开发指南
└── package.json
```
